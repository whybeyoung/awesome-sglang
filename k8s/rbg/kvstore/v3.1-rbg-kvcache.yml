apiVersion: workloads.x-k8s.io/v1alpha1
kind: RoleBasedGroup
metadata:
  name: deepseek-rbg-deploy
  namespace: aiservice
spec:
  roles:
    - name: prefill
      replicas: 1 
      dependencies: [ "decode"]
      workload:
        apiVersion: leaderworkerset.x-k8s.io/v1
        kind: LeaderWorkerSet
      leaderWorkerSet:
        size: 1 
        patchLeaderTemplate:
          metadata:
            labels:
              role: leader
              pd_role: prefill
          spec:
            containers:
            - command:
              - bash
              - -c
              - sleep infinity;
              - ./AIservice
              - -m=1
              - -c=xdeepseekv3testbo.toml
              - -s=xdeepseekv3testbo
              - -u=http://companion-dx.xfyun.iflytek:6868
              - -p=sparkv2
              - -g=pddev
              env:
                - name: FULL_MODEL_PATH
                  value: /work/models/
                - name: SGLANG_CHUNKED_PREFIX_CACHE_THRESHOLD 
                  value: "0"
                - name: CMD_EXTRA_ARGS
                  value: " --enable-hierarchical-cache --hicache-ratio 2 --hicache-size 0   --hicache-mem-layout page_first_direct  --hicache-io-backend direct --hicache-write-policy write_through  --hicache-storage-backend mooncake --hicache-storage-prefetch-policy wait_complete  --max-running-requests 512  --collect-tokens-histogram  --max-total-tokens 131076   --chunked-prefill-size 16384 --tp 8   --context-length 32768   --mem-fraction-static 0.9 --page-size 64  --disaggregation-ib-device  mlx5_bond_0,mlx5_bond_1,mlx5_bond_2,mlx5_bond_3"

                - name: MOONCAKE_MASTER
                  value: "mk-mooncake-master:50051"
                - name: MOONCAKE_TE_META_DATA_SERVER
                  value: "http://mk-mooncake-master:8080/metadata"
                - name: MOONCAKE_GLOBAL_SEGMENT_SIZE
                  value: "0"
                  # MOONCAKE_LOCAL_BUFFER_SIZE is set to 0 because the instance functions solely as a storage server, 
                  # contributing memory to the global pool without issuing any request operations.
                - name: MOONCAKE_LOCAL_BUFFER_SIZE
                  value: "4194304"
                - name: MOONCAKE_PROTOCOL
                  value: "rdma" #support tcp, rdma
                - name: MOONCAKE_DEVICE
                  value: "mlx5_bond_0,mlx5_bond_1,mlx5_bond_2,mlx5_bond_3"
                - name: LWS_WORKER_INDEX
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.labels['leaderworkerset.sigs.k8s.io/worker-index']
              #livenessProbe:
              #  failureThreshold: 3
              #  httpGet:
              #    path: /health
              #    port: 30000
              #  initialDelaySeconds: 300
              #  periodSeconds: 60
              #  successThreshold: 1
              #  timeoutSeconds: 3
              readinessProbe:
                failureThreshold: 20
                httpGet:
                  path: /health
                  port: 30000
                periodSeconds: 30
                successThreshold: 1
                timeoutSeconds: 3
              name: sglang
              ports:
              - containerPort: 30000
                name: sglang-http
                protocol: TCP
    
        patchWorkerTemplate: {}
      template:
        metadata:
          labels:
            inference-framework: sglang
            inference-stack.io/monitoring: "enabled"
        spec:
            containers:
            - name: sglang
              image: iflytek-registry-vpc.cn-beijing.cr.aliyuncs.com/maas/sglang-accl-latest:1.0.121
              imagePullPolicy: Always
              env:
                - name: NVSHMEM_HCA_PE_MAPPING
                  value: "mlx5_bond_0:1:2,mlx5_bond_1:1:2,mlx5_bond_2:1:2,mlx5_bond_3:1:2"
                - name: NVSHMEM_ENABLE_NIC_PE_MAPPING
                  value: "1"
                - name: ASE_CLUSTER_TAG
                  value: "lingjun-ali-dev"
                - name: AIGES_WRAPPER_VERSION
                  value: "1.0.0"
                - name: WIDGET_PLUGIN_MODE
                  value: go
                - name: ENABLE_MULTI_NODE_MODE
                  value: "true"
                - name: DIST_PORT
                  value: "20102"
                - name: MAAS_BACKEND
                  value: sglang
                - name: READ_TIMEOUT
                  value: "600"
                - name: PD_TYPE
                  value: prefill
                - name: AIGES_PD_ROLE
                  value: prefill 
                - name: HTTP_SERVER_PORT
                  value: "30000"
                - name: SGLANG_TOKENIZER_MODE
                  value: noraml
                - name: SGLANG_TOKENIZER_WORKER_NUM
                  value: "1"
                - name: JSON_MODE_SYS_PROMPT_INJECT
                  value: "false"
                - name: CUDA_LAUNCH_BLOCKING
                  value: "0"
                - name:  SGLANG_DISAGGREGATION_BOOTSTRAP_TIMEOUT
                  value: "61"
                - name: NVSHMEM_IB_TRAFFIC_CLASS
                  value: "16"
                - name: NVSHMEM_DISABLE_P2P
                  value: "0"
                - name: ENABLE_METRICS
                  value: "true"
                - name: NVSHMEM_IB_GID_INDEX
                  value: "3"
                - name: NVSHMEM_IB_SL
                  value: "5"
                - name: SGLANG_SET_CPU_AFFINITY
                  value: "true"
                - name: SGLANG_ENABLE_JIT_DEEPGEMM 
                  value: "1"
                - name:  NCCL_IB_QPS_PER_CONNECTION
                  value: "8"
                - name: NCCL_IB_SPLIT_DATA_ON_QPS
                  value: "1"
                - name: NCCL_NET_PLUGIN
                  value: "none"
                - name: NCCL_IB_TC
                  value: "136"
                - name: NCCL_IB_SL
                  value: "5"
                - name: NCCL_IB_TIMEOUT
                  value: "22"
                - name: NCCL_IB_GID_INDEX
                  value: "3"
                - name: NCCL_MIN_NCHANNELS
                  value: "4"
                - name: NCCL_SOCKET_IFNAME
                  value: bond1 
                - name: GLOO_SOCKET_IFNAME
                  value: bond1 
                - name: NCCL_IB_HCA
                  value: ^=mlx5_0,mlx5_5,mlx5_6
                - name: NVSHMEM_BOOTSTRAP_UID_SOCK_IFNAME
                  value: "bond1"
                - name: MC_TE_METRIC
                  value: "false"
              resources:
                limits:
                  nvidia.com/gpu: "8"
              securityContext:
                capabilities:
                  add:
                  - IPC_LOCK
                privileged: true
              volumeMounts:
                - mountPath: /dev/shm
                  name: dshm
                - mountPath: /work/models
                  name: model
                - mountPath: /dev/infiniband
                  name: ib              
            dnsPolicy: ClusterFirstWithHostNet
            hostIPC: true
            hostNetwork: true
            hostAliases:
            - hostnames:
              - artifacts.iflytek.com
              ip: 10.103.57.100
            - hostnames:
              - xconf01.aiaas.bjb
              - zk01.aiaas.bjb
              ip: 172.21.161.28
            - hostnames:
              - xconf02.aiaas.bjb
              - zk02.aiaas.bjb
              - companion-dx.xfyun.iflytek
              ip: 172.21.161.29
            - hostnames:
              - xconf03.aiaas.bjb
              - zk03.aiaas.bjb
              ip: 172.21.161.30
            - hostnames:
              - companion-yd.xfyun.iflytek
              ip: 10.246.71.208
            - hostnames:
              - mss01.aiaas.bjb
              ip: 172.21.115.22
            - hostnames:
              - mss02.aiaas.bjb
              ip: 172.21.115.35
            - hostnames:
              - dz-qos-212-081
              ip: 172.21.212.81
            - hostnames:
              - dz-qos-212-082
              - zk002.bjb.odeon.cn
              ip: 172.21.212.82
            - hostnames:
              - dz-qos-212-083
              ip: 172.21.212.83
            - hostnames:
              - dz-qos-212-090
              - zk003.bjb.odeon.cn
              ip: 172.21.212.90
            - hostnames:
              - dz-qos-212-091
              - zk004.bjb.odeon.cn
              ip: 172.21.212.91
            - hostnames:
              - dz-qos-212-092
              ip: 172.21.212.92
            - hostnames:
              - dz-qos-212-098
              ip: 172.21.212.98
            - hostnames:
              - dz-qos-212-099
              ip: 172.21.212.99
            - hostnames:
              - dz-qos-212-100
              ip: 172.21.212.100
            - hostnames:
              - dz-qos-212-101
              ip: 172.21.212.101
            - hostnames:
              - dz-qos-212-102
              - zk005.bjb.odeon.cn
              ip: 172.21.212.102
            - hostnames:
              - xiaotian.xfyun.iflytek
              - s.msp.xconf
              ip: 172.21.124.126
            - hostnames:
              - oss-beijing-sh-internal.openstorage.cn
              ip: 172.22.237.200
            - hostnames:
              - data-api-dx.aiaasapi.cn
              ip: 10.105.184.190
            - hostnames:
              - inner-webgate-patch.aipaasapi.cn
              ip: 172.21.161.184
            - hostnames:
              - gcs-maas.cn-beijing-1.rdg.private
              ip: 10.109.185.31
            nodeSelector: 
              maas: "yes"
            tolerations:
              - key: pd_share
                operator: Exists
              - key: bopd
                operator: Exists
              - key: maas 
                operator: Exists
              - key: node-role.alibabacloud.com/lingjun
                operator: Exists
              - key: oss
                operator: Exists 
              - key: ds31 
                operator: Exists 
            volumes:
            - hostPath:
                path: /var/run/sys-topology
              name: topo
            - emptyDir:
                medium: Memory
              name: dshm
            - hostPath:
                path: /data1/maas_hosted_models/DeepSeek-V3.1-Terminus/ 
              name: model
            - hostPath:
                path: /dev/infiniband
              name: ib

    - name: decode
      replicas: 1
      workload:
        apiVersion: leaderworkerset.x-k8s.io/v1
        kind: LeaderWorkerSet
      leaderWorkerSet:
        size: 2
        patchLeaderTemplate:
          metadata:
            labels:
              role: leader
              pd_role: decode
          spec:
            containers:
            - command:
              - ./AIservice
              - -m=1
              - -c=xdeepseekv3testbo-decode.toml
              - -s=xdeepseekv3testbo
              - -u=http://companion-dx.xfyun.iflytek:6868
              - -p=sparkv2
              - -g=pddev
              env:
              - name: FULL_MODEL_PATH
                value: /work/models/
              - name: CMD_EXTRA_ARGS 
                value: " --prefill-round-robin-balance  --moe-a2a-backend  deepep --detokenizer-worker-num 4 --crash-dump-folder /log    --eplb-rebalance-layers-per-chunk 29 --init-expert-location /home/aiges/tuned/attachment_ep_statistics/decode_in500out1500.json  --enable-dp-lm-head   --page-size 64    --chunked-prefill-size 131072  --enable-dp-attention --tp-size 16 --dp-size 16  --deepep-mode low_latency   --context-length 32768    --mem-fraction-static 0.8 --cuda-graph-max-bs 64 --max-running-requests  2048  --ep-num-redundant-experts 32  --moe-dense-tp-size 1  --disaggregation-ib-device mlx5_bond_0,mlx5_bond_1,mlx5_bond_2,mlx5_bond_3 "
              - name: LWS_WORKER_INDEX
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.labels['leaderworkerset.sigs.k8s.io/worker-index']
              #livenessProbe:
              #  failureThreshold: 3
              #  httpGet:
              #    path: /health
              #    port: 30000
              #  initialDelaySeconds: 300
              #  periodSeconds: 60
              #  successThreshold: 1
              #  timeoutSeconds: 3
              name: sglang
              readinessProbe:
                failureThreshold: 20
                httpGet:
                  path: /health
                  port: 30000
                periodSeconds: 30
                successThreshold: 1
                timeoutSeconds: 3
        patchWorkerTemplate:
          spec:
            containers:
            - command:
                - python3
                - -m
                - sglang.launch_server
                - --model-path
                - /work/models
                - --prefill-round-robin-balance 
                - --crash-dump-folder
                -  /log
                - --detokenizer-worker-num
                - "8"
                - --tokenizer-worker-num
                - "8"
                - --init-expert-location
                - /home/aiges/tuned/attachment_ep_statistics/decode_in500out1500.json
                - --chunked-prefill-size
                - "131072"
                - --eplb-rebalance-layers-per-chunk
                - "29"
                - --page-size
                - "64"
                - --enable-dp-attention
                - --enable-dp-lm-head 
                - --dp-size
                - "16"
                - --moe-a2a-backend
                - "deepep"
                - --deepep-mode
                - low_latency
                - --disaggregation-mode
                - decode
                - --mem-fraction-static
                -  "0.8"
                - --context-length
                - "32768"
                - --disaggregation-ib-device
                - mlx5_bond_0,mlx5_bond_1,mlx5_bond_2,mlx5_bond_3 
                - --cuda-graph-max-bs
                - "64"
                - --max-running-requests
                - "2048"
                - --tp-size
                - "16" # Size of Tensor Parallelism
                - --dist-init-addr
                - $(LWS_LEADER_ADDRESS):20102
                - --nnodes
                - $(LWS_GROUP_SIZE)
                - --node-rank
                - $(LWS_WORKER_INDEX)
                - --trust-remote-code
                - --ep-num-redundant-experts
                - "32"
                - --moe-dense-tp-size
                - "1"
              env:
              - name: LWS_WORKER_INDEX
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.labels['leaderworkerset.sigs.k8s.io/worker-index']
              name: sglang
      template:
        metadata:
          labels:
            inference-framework: sglang-unuse
            inference-stack.io/monitoring: "enabled"
        spec:
            containers:
            - image: iflytek-registry-vpc.cn-beijing.cr.aliyuncs.com/maas/sglang-accl-latest:1.0.121
              imagePullPolicy: Always
              name: sglang
              resources:
                limits:
                  nvidia.com/gpu: "8"
              securityContext:
                capabilities:
                  add:
                  - IPC_LOCK
                privileged: true
              volumeMounts:
                - mountPath: /dev/shm
                  name: dshm
                - mountPath: /work/models
                  name: model
                - mountPath: /dev/infiniband
                  name: ib
                - mountPath: /coredump
                  name: core 
              env:
                - name: CUDA_ENABLE_COREDUMP_ON_EXCEPTION
                  value: "1"
                - name: CUDA_COREDUMP_SHOW_PROGRESS
                  value: "1"
                - name: CUDA_COREDUMP_GENERATION_FLAGS
                  value: 'skip_nonrelocated_elf6images,skip_global_memory,skip_shared_memory,skip_local_memory'
                - name: CUDA_COREDUMP_FILE
                  value: "/coredump/cuda_coredump_%h.%p.%t"
                - name: NVSHMEM_HCA_PE_MAPPING
                  value: "mlx5_bond_0:1:2,mlx5_bond_1:1:2,mlx5_bond_2:1:2,mlx5_bond_3:1:2"
                - name: NVSHMEM_ENABLE_NIC_PE_MAPPING
                  value: "1"
                - name: ASE_CLUSTER_TAG
                  value: "lingjun-ali-dev"
                - name: AIGES_WRAPPER_VERSION
                  value: "1.0.0"
                - name: WIDGET_PLUGIN_MODE
                  value: go
                - name: ENABLE_MULTI_NODE_MODE
                  value: "true"
                - name: DIST_PORT
                  value: "20102"
                - name: MAAS_BACKEND
                  value: sglang
                - name: READ_TIMEOUT
                  value: "600"
                - name: PD_TYPE
                  value: decode
                - name: AIGES_PD_ROLE
                  value: decode
                - name: HTTP_SERVER_PORT
                  value: "30000"
                - name: SGLANG_TOKENIZER_MODE
                  value: noraml
                - name: SGLANG_TOKENIZER_WORKER_NUM
                  value: "8"
                - name: JSON_MODE_SYS_PROMPT_INJECT
                  value: "false"
                - name: SGLANG_DISAGGREGATION_WAITING_TIMEOUT 
                  value: "100000000"
                - name: NVSHMEM_DISABLE_P2P
                  value: "0"
                - name: NVSHMEM_IB_TRAFFIC_CLASS
                  value: "16"
                - name: NVSHMEM_IB_SL
                  value: "5"
                - name: ENABLE_METRICS
                  value: "true"
                - name: CUDA_LAUNCH_BLOCKING
                  value: "0"
                - name: NVSHMEM_IB_GID_INDEX
                  value: "3"
                - name:  NCCL_IB_QPS_PER_CONNECTION
                  value: "8"
                - name: NCCL_IB_SPLIT_DATA_ON_QPS
                  value: "1"
                - name: NCCL_NET_PLUGIN
                  value: "none"
                - name: NCCL_IB_TC
                  value: "136"
                - name: NCCL_IB_SL
                  value: "5"
                - name: NCCL_IB_TIMEOUT
                  value: "22"
                - name: NCCL_IB_GID_INDEX
                  value: "3"
                - name: NCCL_MIN_NCHANNELS
                  value: "4"
                - name: NCCL_SOCKET_IFNAME
                  value: bond1
                - name: GLOO_SOCKET_IFNAME
                  value: bond1
                - name: NVSHMEM_BOOTSTRAP_UID_SOCK_IFNAME
                  value: "bond1"
                - name: NCCL_IB_HCA
                  value: ^=mlx5_0,mlx5_5,mlx5_6
                - name: MC_TE_METRIC
                  value: "false"
                - name: SGLANG_ENABLE_JIT_DEEPGEMM 
                  value: "1"
                - name: ACCL_LOAD_BALANCE
                  value: "1"
                - name: ACCL_TOPO_FIX
                  value: "1"
                - name:  ACCL_LOW_LATENCY_OPTIMIZE
                  value: "3"
                - name: ACCL_DISPATCH_NUM_WARP_GROUPS
                  value: "4"
                - name: ACCL_COMBINE_NUM_WARP_GROUPS
                  value: "4"
            dnsPolicy: ClusterFirstWithHostNet
            hostIPC: true
            hostNetwork: true
            hostAliases:
            - hostnames:
              - artifacts.iflytek.com
              ip: 10.103.57.100
            - hostnames:
              - xconf01.aiaas.bjb
              - zk01.aiaas.bjb
              ip: 172.21.161.28
            - hostnames:
              - xconf02.aiaas.bjb
              - zk02.aiaas.bjb
              - companion-dx.xfyun.iflytek
              ip: 172.21.161.29
            - hostnames:
              - xconf03.aiaas.bjb
              - zk03.aiaas.bjb
              ip: 172.21.161.30
            - hostnames:
              - companion-yd.xfyun.iflytek
              ip: 10.246.71.208
            - hostnames:
              - mss01.aiaas.bjb
              ip: 172.21.115.22
            - hostnames:
              - mss02.aiaas.bjb
              ip: 172.21.115.35
            - hostnames:
              - dz-qos-212-081
              ip: 172.21.212.81
            - hostnames:
              - dz-qos-212-082
              - zk002.bjb.odeon.cn
              ip: 172.21.212.82
            - hostnames:
              - dz-qos-212-083
              ip: 172.21.212.83
            - hostnames:
              - dz-qos-212-090
              - zk003.bjb.odeon.cn
              ip: 172.21.212.90
            - hostnames:
              - dz-qos-212-091
              - zk004.bjb.odeon.cn
              ip: 172.21.212.91
            - hostnames:
              - dz-qos-212-092
              ip: 172.21.212.92
            - hostnames:
              - dz-qos-212-098
              ip: 172.21.212.98
            - hostnames:
              - dz-qos-212-099
              ip: 172.21.212.99
            - hostnames:
              - dz-qos-212-100
              ip: 172.21.212.100
            - hostnames:
              - dz-qos-212-101
              ip: 172.21.212.101
            - hostnames:
              - dz-qos-212-102
              - zk005.bjb.odeon.cn
              ip: 172.21.212.102
            - hostnames:
              - xiaotian.xfyun.iflytek
              - s.msp.xconf
              ip: 172.21.124.126
            - hostnames:
              - oss-beijing-sh-internal.openstorage.cn
              ip: 172.22.237.200
            - hostnames:
              - data-api-dx.aiaasapi.cn
              ip: 10.105.184.190
            - hostnames:
              - inner-webgate-patch.aipaasapi.cn
              ip: 172.21.161.184
            - hostnames:
              - gcs-maas.cn-beijing-1.rdg.private
              ip: 10.109.185.31
            nodeSelector:
              maas: "yes"
            tolerations:
              - key: pd_share
                operator: Exists
              - key: bopd
                operator: Exists
              - key: maas 
                operator: Exists
              - key: node-role.alibabacloud.com/lingjun
                operator: Exists
              - key: oss
                operator: Exists 
              - key: ds31 
                operator: Exists 
            volumes:
            - hostPath:
                path: /var/run/sys-topology
              name: topo
            - emptyDir:
                medium: Memory
              name: dshm
            - hostPath:
                path: /data1/maas_hosted_models/DeepSeek-V3.1-Terminus/ 
              name: model
            - hostPath:
                path: /dev/infiniband
              name: ib
            - hostPath:
                path: /data1/maas_core
              name: core

    - name: kvmetadata
      replicas: 1
      template:
        spec:
          containers:
            - name: metadata
              image: iflytek-registry-vpc.cn-beijing.cr.aliyuncs.com/maas/sglang-accl-latest:1.0.87-ckpt
              command:
                - bash
                - -c
                - "sleep infinity"
    - name: kvmaster
      replicas: 1
      template:
        spec:
          containers:
            - name: metadata
              image: iflytek-registry-vpc.cn-beijing.cr.aliyuncs.com/maas/sglang-accl-latest:1.0.87-ckpt
              command:
                - bash
                - -c
                - "sleep infinity"

    - name: router
      replicas: 1 
      dependencies: [ "decode", "prefill" ]
      template:
        spec:
          hostIPC: true 
          hostNetwork: true 
          nodeSelector:
              bo: "yes"
          tolerations:
              - key: pd_share
                operator: Exists
              - key: bopd
                operator: Exists
              - key: maas
                operator: Exists
              - key: node-role.alibabacloud.com/lingjun
                operator: Exists
              - key: oss
                operator: Exists
          containers:
            - name: scheduler
              image: artifacts.iflytek.com/docker-private/maas/sglang-accl-latest:1.0.87-ckpt
              command:
              - sh
              - -c
              - >
                python3 -m sglang_router.launch_router
                --host 0.0.0.0
                --port 8080
                --pd-disaggregation
                --policy random
                --service-discovery
                --service-discovery-namespace ${NAMESPACE}
                --service-discovery-port 30000
                --prefill-selector pd_role=prefill
                --decode-selector pd_role=decode
                --max-payload-size 2147483648
                --worker-startup-timeout-secs 1200
              env:
              - name: NAMESPACE
                valueFrom:
                  fieldRef:
                    apiVersion: v1
                    fieldPath: metadata.namespace
              volumeMounts:
                - mountPath: /work/models
                  name: model
          volumes:
            - hostPath:
                path: /data1/maas_hosted_models/models/v30324/v30324
              name: model
     
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: deepseek-rbg-deploy
  name: deepseek-rbg-deploy
  namespace: aiservice
spec:
  ports:
    - name: http
      port: 8080
      protocol: TCP
      targetPort: 8080
      nodePort: 30080
  selector:
    rolebasedgroup.workloads.x-k8s.io/name: deepseek-rbg-deploy
    rolebasedgroup.workloads.x-k8s.io/role: router
  type: NodePort
